---
title: Utforsking av utenforsskap i vår region (NEET), basert på data fra SSB
author: Lars Bauger 
format: 
  dashboard:
    orientation: columns
    theme: yeti
    logo: "img/bamse.jpg"
---

```{r, loading packages}
#| message: false
#| include: false
library(tidyverse)
library(httr2)
library(sf)
library(leaflet)
library(gt)
Sys.setlocale(locale = 'no_NB.utf8')
```

```{r, laste data}
# få data inn
# Loading libraries
df_kjonn <- read_rds(here::here("data/kjonn_neet"))
sobru_reg <- read_rds("data/kart_sobru_reg")
df_inn <- read_rds(here::here("data/innvandring_neet")) |> 
  mutate(tid =as.integer(tid),
         neet_andel = round(neet_andel,1))

df_desc_sf <- st_as_sf(sobru_reg, sf_column_name = "geometry")


# Kombinere datasett

df_desc_sf_midlertidig <- df_desc_sf |> 
  filter(alder == "15-29 år",
         kjonn == "Begge kjønn") |> 
  select(!c("tot", "NEET", "alder", "fylkesnavn"))
df_kombinert <- df_desc_sf_midlertidig |>
  left_join(df_inn, by = c("region", "tid"))


```


## column

### Row {height="60%"}

```{r, stolpe_diagram}
barplot <- df_kombinert |> 
  filter(tid == 2024 &
         fylkesnavn %in% c("Buskerud", "Vestfold", "Telemark"),
         kjonn == "Begge kjønn",
         alder == "15-29 år",
         innvandringskategori == "I alt") |> 
  ggplot(aes(x = reorder(region, neet_andel.x), y = neet_andel.x, fill = region)) + 
  geom_bar(stat = "identity")+
  scale_fill_manual(values=ggsci::pal_igv()(40)) +
  theme_classic() +
  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(x = "Kommuner i Buskerud, Vestfold og Telemark", 
       y = "Andel NEET blant 15-29 åringer i 2024")+
  geom_hline(yintercept = 9.9, linetype = "dashed", color = "steelblue", size =0.7) +
  annotate("text", x = 15, y = 13, label = "Stiplet blå linje representerer landsgjennomsnitt", color = "black", hjust = 0) +
  annotate("rect", xmin = 5.5, xmax = 24, ymin = 12.5, ymax = 13.5, alpha = 0.2, fill = "steelblue")
plotly::ggplotly(barplot)

fasett_fylk <- barplot +facet_grid(rows = vars(fylkesnavn))

```

### Row {height="20%"}

```{r, infoboks}
#| component: valuebox
#| title: Norge
list(
  icon = "percent",
  color = "#8b0000",
  value = df_kjonn |> 
    filter(tid == 2024,
           fylkesnavn == "Norge",
           kjonn == "Begge kjønn",
           alder == "15-29 år")|>
    dplyr::pull(neet_andel) |> 
    round(1) |> 
    format(nsmall = 1))

```

```{r, vbt}
#| component: valuebox
#| title: Vår region
list(
  icon = "percent",
  color = "info",
  value = df_kjonn |>
    filter(
      tid == 2024,
      fylkesnavn %in% c("Vestfold", "Telemark", "Buskerud"),
      kjonn == "Begge kjønn",
      alder == "15-29 år"
    ) |>
    #lager et vektet gjennomsnitt hvor total antall i kommunene vektes i gjennomsnittskåren
    summarise(
      neet_pct = weighted.mean(neet_andel, 
                               w = tot, 
                               na.rm = TRUE)
    ) |>
    dplyr::pull(neet_pct)|>
    round(1) |>
    format(nsmall = 1))




```

```{r, buskerud}
#| component: valuebox
#| title: Buskerud
list(
  icon = "percent",
  color = "#0072B2",
  value = df_kjonn |> 
    filter(tid == 2024,
           fylkesnavn == "Buskerud",
           kjonn == "Begge kjønn",
           alder == "15-29 år")|>
    summarise(neet_pct = weighted.mean(neet_andel, 
                                       w = tot, 
                                       na.rm = TRUE)
    ) |>
    pull(neet_pct) |>
    round(1) |>
    format(nsmall = 1))

```

```{r, vestfold}
#| component: valuebox
#| title: Vestfold
list(
  icon = "percent",
  color = "#009E73",
  value = df_kjonn |> 
    filter(tid == 2024,
           fylkesnavn == "Vestfold",
           kjonn == "Begge kjønn",
           alder == "15-29 år")|>
    summarise(neet_pct = weighted.mean(neet_andel, 
                                       w = tot, 
                                       na.rm = TRUE)
    ) |>
    pull(neet_pct) |>
    round(1) |>
    format(nsmall = 1))

```

```{r, telemark}
#| component: valuebox
#| title: Telemark
list(
  icon = "percent",
  color = "#E69F00",
  value = df_kjonn |> 
    filter(tid == 2024,
           fylkesnavn == "Telemark",
           kjonn == "Begge kjønn",
           alder == "15-29 år")|>
    summarise(neet_pct = weighted.mean(neet_andel, 
                                       w = tot, 
                                       na.rm = TRUE)
    ) |>
    pull(neet_pct) |>
    round(1) |>
    format(nsmall = 1))
```

## column 

```{r}
#| title: Fylkesvis stolpediagram
barplot_facet <- df_kombinert |> 
  filter(tid == 2024 &
         fylkesnavn %in% c("Buskerud", "Vestfold", "Telemark"),
         kjonn == "Begge kjønn",
         alder == "15-29 år",
         innvandringskategori == "I alt") |> 
  ggplot(aes(x = reorder(region, neet_andel.x), y = neet_andel.x, fill = region)) + 
  geom_bar(stat = "identity")+
  scale_fill_manual(values=ggsci::pal_igv()(40)) +
  theme_classic(base_size = 14) +
  theme(legend.position="none", axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(y = "Andel NEET blant 15-29 åringer i 2024",
       x = "")+
  geom_hline(yintercept = 10, linetype = "dashed", color = "steelblue", size =0.3) +
  annotate("text", x = 15, y = 12.2, label = "Stiplet blå linje representerer landsgjennomsnitt", color = "black", hjust = 0) + 
  facet_grid(rows = vars(fylkesnavn))
plotly::ggplotly(barplot_facet)

```

